<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Калистеника: 3-дневная программа для продвинутых</title>
  <link rel="preconnect" href="https://r2cdn.perplexity.ai" crossorigin>
  <style>
    /* --- DESIGN SYSTEM --- */
    :root {
      /* (Все переменные дизайн-системы из подсказки...) */
      --color-bg-push: var(--color-bg-6);
      --color-bg-pull: var(--color-bg-4);
      --color-bg-core: var(--color-bg-3);
      --color-bg-leg: var(--color-bg-2);
    }
    /* (скопируйте сюда всё содержимое дизайн-системы полностью из подсказки) */
    /* --- END DESIGN SYSTEM --- */

    body {
      min-height: 100vh;
      background: var(--color-background);
    }

    .main-nav {
      display: flex;
      gap: var(--space-8);
      padding: var(--space-16) 0;
      background: var(--color-surface);
      border-radius: var(--radius-lg);
      margin-bottom: var(--space-16);
      justify-content: center;
      align-items: center;
      flex-wrap: wrap;
    }
    .nav-tab, .nav-tab.active {
      border: none;
      background: var(--color-secondary);
      color: var(--color-text-secondary);
      padding: var(--space-12) var(--space-16);
      font-size: var(--font-size-lg);
      font-weight: var(--font-weight-semibold);
      border-radius: var(--radius-full);
      cursor: pointer;
      transition: background var(--duration-fast);
    }
    .nav-tab.active {
      background: var(--color-primary);
      color: var(--color-btn-primary-text);
      box-shadow: var(--shadow-md);
    }
    .progress-overview {
      background: var(--color-bg-5);
      border-radius: var(--radius-lg);
      margin-bottom: var(--space-16);
      padding: var(--space-16);
      display: flex;
      flex-direction: column;
      gap: var(--space-8);
    }
    .muscle-groups {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-8);
      margin-bottom: var(--space-16);
    }
    .muscle-tag {
      background: var(--color-secondary);
      color: var(--color-text-secondary);
      padding: var(--space-4) var(--space-8);
      border-radius: var(--radius-md);
      font-size: var(--font-size-sm);
    }
    .section-card {
      background: var(--color-surface);
      border-radius: var(--radius-base);
      margin-bottom: var(--space-16);
      box-shadow: var(--shadow-xs);
      padding: var(--space-16);
    }
    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      font-size: var(--font-size-lg);
      font-weight: var(--font-weight-bold);
    }
    .section-content {
      margin-top: var(--space-8);
      display: none;
    }
    .section-card.open .section-content {
      display: block;
    }
    .exercise-row {
      margin-bottom: var(--space-16);
      border-left: 4px solid var(--color-border);
      padding-left: var(--space-12);
    }
    .exercise-head {
      display: flex;
      align-items: center;
      gap: var(--space-8);
      justify-content: space-between;
    }
    .exercise-title {
      font-weight: var(--font-weight-semibold);
      font-size: var(--font-size-base);
      cursor: pointer;
    }
    .completed-checkbox {
      accent-color: var(--color-success);
      transform: scale(1.2);
      margin-right: var(--space-4);
    }
    .exercise-details {
      display: none;
      padding: var(--space-8) 0 0 var(--space-8);
      font-size: var(--font-size-sm);
    }
    .exercise-row.open .exercise-details {
      display: block;
      animation: fadein 0.2s;
    }
    .exercise-progress-bar {
      height: 6px;
      border-radius: 4px;
      background: var(--color-bg-7);
      width: 100%;
      margin: var(--space-8) 0;
    }
    .exercise-progress-bar .progress-inner {
      height: 100%;
      border-radius: 4px;
      background: var(--color-primary);
    }
    .timer-btn {
      background: var(--color-bg-3);
      color: var(--color-text);
      padding: var(--space-4) var(--space-12);
      border: none;
      border-radius: var(--radius-sm);
      margin-left: var(--space-4);
      cursor: pointer;
      font-size: var(--font-size-sm);
    }
    .timer-btn.running {
      background: var(--color-primary);
      color: var(--color-btn-primary-text);
    }
    .tips-section, .recovery-section {
      background: var(--color-surface);
      border-radius: var(--radius-base);
      margin-bottom: var(--space-16);
      padding: var(--space-16);
      box-shadow: var(--shadow-xs);
    }
    .tips-list, .recovery-list {
      font-size: var(--font-size-base);
      margin-left: var(--space-8);
    }
    .container {
      max-width: var(--container-lg);
    }
    @media (max-width: 720px) {
      .main-nav {
        flex-direction: column;
        gap: var(--space-16);
      }
    }
  </style>
</head>
<body>
  <main class="container" id="app"></main>
  <script>
    // Основные данные (Hardcoded JSON из application_data_json для быстрого доступа) 
    const trainingProgram = /* Склеенное JS-объектное представление JSON данных из application_data_json */ {};

    // Темплейт Helper-ы
    function createTag(text) {
      return `<span class="muscle-tag">${text}</span>`;
    }
    function toMins(secs) {
      return Math.floor(secs / 60) + ' мин.';
    }
    // ... более подробные helper-ы для вложенных структур ниже

    // Состояния для чекбоксов выполнения, открытых секций и табов
    let activeDayIdx = 0;
    let daySectionOpen = [true, false, false];
    let completedMap = {};
    let openedSections = {};
    let openedExercise = {};
    
    // Отрисовка навигации (Tabs)
    function renderNav() {
      const days = [trainingProgram.day_1_push_handstand, trainingProgram.day_2_pull_legs_lever, trainingProgram.day_3_balanced_planche_core];
      return `<nav class="main-nav">
        ${days.map((d, i) => `<button class="nav-tab${activeDayIdx===i?' active':''}" onclick="setDay(${i})">${d.name}</button>`).join('')}
      </nav>`;
    }
    function renderProgress() {
      // Показываем краткий прогресс на 3 дня (update c учетом state)
      let percentDone = 0, total = 0, done = 0;
      for (let i=0; i<3; i++) {
        const sections = Object.values(trainingProgram[`day_${i+1}_${['push_handstand','pull_legs_lever','balanced_planche_core'][i]}`].main_workout);
        for (const sec of sections) {
          for (const ex of sec.exercises) {
            const id = `${i}_${sec.name}_${ex.exercise}`;
            total++;
            if (completedMap[id]) done++;
          }
        }
      }
      percentDone = Math.round((done/Math.max(1,total))*100);
      return `<div class="progress-overview">
        <strong>Прогресс недели: ${percentDone}%</strong>
        <div class="exercise-progress-bar"><div class="progress-inner" style="width:${percentDone}%;"></div></div>
        <span>Выполнено упражнений: ${done}/${total}</span>
      </div>`;
    }
    function renderMuscleGroups(day) {
      return `<div class="muscle-groups">${day.focus_muscles.map(m=>createTag(m)).join('')}</div>`;
    }
    function renderDayOverview(day) {
      return `<div style="margin-bottom:20px">
        <div><strong>Цели дня:</strong> ${day.goals.join(', ')}</div>
        <div>Ориентировочная продолжительность: <b>${day.estimated_time} мин.</b></div>
      </div>`;
    }
    function renderSection(sec, secIdx, dayIdx, isOpen) {
      return `<section class="section-card${isOpen?' open':''}" id="sec_${dayIdx}_${secIdx}">
        <div class="section-header" onclick="toggleSection('${dayIdx}_${secIdx}')">
          ${sec.name}
          <span>${isOpen ? '▲' : '▼'}</span>
        </div>
        <div class="section-content">
          ${sec.exercises?sec.exercises.map((ex, exIdx) => renderExerciseRow(ex, sec, dayIdx, secIdx, exIdx)).join('')
            : sec.stretches?sec.stretches.map((str, strIdx) => renderStretchRow(str, dayIdx, secIdx, strIdx)).join('')
            : sec.duration?`<b>Длительность:</b> ${sec.duration} минут` : ''}
        </div>
      </section>`;
    }
    function renderExerciseRow(ex, sec, dayIdx, secIdx, exIdx) {
      const exId = `${dayIdx}_${sec.name}_${ex.exercise}`;
      const isChecked = completedMap[exId]||false;
      const isOpen = openedExercise[exId]||false;
      return `<div class="exercise-row${isOpen?' open':''}" id="${exId.replace(/[^a-z0-9]/gi,'_')}">
        <div class="exercise-head" onclick="toggleExercise('${exId}')">
          <span>
            <input type="checkbox" class="completed-checkbox" ${isChecked?'checked':''}
              onclick="event.stopPropagation();toggleCompleted('${exId}')">
            <span class="exercise-title">${ex.exercise} ${ex.sets_reps?`<span style='color:var(--color-text-secondary)'>(${ex.sets_reps})</span>`:''}</span>
          </span>
          ${ex.description && ex.sets_reps && /сек|секунд|минut|hold|держите/i.test(ex.sets_reps+ex.description)? `<button class="timer-btn" onclick="event.stopPropagation();openTimer('${ex.exercise}', '${ex.sets_reps}')">⏱️ Таймер</button>` : ''}
        </div>
        <div class="exercise-details">
          <b>Мышцы:</b> ${ex.target_muscles?ex.target_muscles.map(createTag).join(' '):''}<br>
          <b>Описание:</b> ${ex.description||''}<br>
          ${ex.form_cues?`<b>Ключевые акценты:</b> <ul>${ex.form_cues.map(c=>`<li>${c}</li>`).join('')}</ul>`:''}
          ${ex.common_mistakes?`<b>Ошибка:</b> <ul>${ex.common_mistakes.map(m=>`<li>${m}</li>`).join('')}</ul>`:''}
          ${(ex.progressions||ex.progression_details)?
            `<b>Прогрессии:</b>${ex.progression_details?
              '<ul>' + ex.progression_details.map(pr=>`<li><b>${pr.level}:</b> ${pr.description}</li>`).join('') + '</ul>' :
              `<ul><li>Текущий уровень: ${ex.progressions?.current||''}</li><li>Следующий: ${ex.progressions?.next||''}</li><li>Сложно: ${ex.progressions?.advanced||''}</li></ul>`
            }` : ''}
        </div>
      </div>`;
    }
    function renderStretchRow(str, dayIdx, secIdx, strIdx) {
      return `<div class="exercise-row" style="border-left:2px dashed var(--color-info)">
        <span class="exercise-title">${str.stretch} <span style='color:var(--color-text-secondary)'>(${str.duration||''})</span></span><br>
        <b>Фокус:</b> ${str.focus?str.focus.map(createTag).join(' '):''}
        <br><b>Описание:</b> ${str.description}
      </div>`;
    }

    function renderDay(day, dayIdx) {
      let mainSections = Object.values(day.main_workout).map( (sec, i) => renderSection(sec, i, dayIdx, openedSections[`${dayIdx}_${i}`]||false) ).join('');
      let warmUpSection = renderSection({name:"Разминка", exercises: day.warm_up}, -1, dayIdx, openedSections[`${dayIdx}_warmup`]||true);
      let stretchSection = renderSection(day.cool_down_stretching, 99, dayIdx, openedSections[`${dayIdx}_stretch`]||false);
      return `<div>${renderDayOverview(day)}
        ${renderMuscleGroups(day)}
        ${warmUpSection}
        ${mainSections}
        ${stretchSection}
      </div>`;
    }

    function renderTips() {
      return `<section class="tips-section">
        <div class="section-header" onclick="toggleTips()">${trainingProgram.tips_and_recommendations.title} <span>${tipsOpen?'▲':'▼'}</span></div>
        <div class="section-content" style="display:${tipsOpen?'block':'none'}">
          <ul class="tips-list">
            ${trainingProgram.tips_and_recommendations.tips.map(t=>`<li><b>${t.tip}:</b> ${t.description}</li>`).join('')}
          </ul>
        </div>
      </section>`;
    }
    function renderRecovery() {
      return `<section class="recovery-section">
        <div class="section-header" onclick="toggleRecovery()">${trainingProgram.recovery_nutrition.title} <span>${recoveryOpen?'▲':'▼'}</span></div>
        <div class="section-content" style="display:${recoveryOpen?'block':'none'}">
          ${trainingProgram.recovery_nutrition.sections.map(sec=>`<b>${sec.section}</b><ul class="recovery-list">${sec.points.map(pt=>`<li>${pt}</li>`).join('')}</ul>`).join('')}
        </div>
      </section>`;
    }

    // Таймер
    let timerWindow = null;
    function openTimer(name, preset) {
      let m = 0;
      let match = preset.match(/([0-9]{1,2})[ ]*([минутминсексек]*)/);
      if (match) {
        if (/мин/.test(match[2])) m = parseInt(match[1]);
        else if (/сек/.test(match[2])) m = 0, s = parseInt(match[1]);
      }
      let totalSec = (m||0)*60 + (parseInt(match?.[1])||30);
      showTimerModal(name, totalSec);
    }
    function showTimerModal(title, duration) {
      // выбрасываем примитивный фиксированный таймер для демо-целей
      if (timerWindow) timerWindow.remove();
      timerWindow = document.createElement('div');
      timerWindow.style.cssText = 'position:fixed;left:0;top:0;width:100vw;height:100vh;background:rgba(0,0,0,0.4);z-index:9999;display:flex;align-items:center;justify-content:center;';
      let inner = document.createElement('div');
      inner.style.cssText = 'background:#fff;padding:30px;border-radius:16px;max-width:300px;text-align:center;box-shadow:0 8px 24px rgba(0,0,0,0.2);color:#000;';
      inner.innerHTML = `<b>${title}</b><div id='timer-sec' style='font-size:2em;padding:16px;'></div><button class='btn btn--primary' id='timer-close'>Закрыть</button>`;
      timerWindow.appendChild(inner);
      document.body.appendChild(timerWindow);
      let timerElem = inner.querySelector('#timer-sec');
      let left = duration, timerHandle = setInterval(()=>{
        timerElem.innerText = `${Math.floor(left/60)}:${(left%60).toString().padStart(2,'0')}`;
        if (--left < 0) { clearInterval(timerHandle); timerElem.innerHTML='⏰ Готово!'; }
      }, 1000);
      inner.querySelector('#timer-close').onclick = ()=>{document.body.removeChild(timerWindow); timerWindow=null;};
    }

    // --- UI Event handlers ---
    function setDay(idx) { activeDayIdx=idx; update(); }
    function toggleSection(id) { openedSections[id]=!openedSections[id]; update(); }
    function toggleExercise(id) { openedExercise[id]=!openedExercise[id]; update(); }
    function toggleCompleted(id) { completedMap[id]=!completedMap[id]; update(); }
    let tipsOpen = false, recoveryOpen = false;
    function toggleTips() { tipsOpen=!tipsOpen; update(); }
    function toggleRecovery() { recoveryOpen=!recoveryOpen; update(); }

    // --- RENDER MAIN APP ---
    function update() {
      const days = [trainingProgram.day_1_push_handstand, trainingProgram.day_2_pull_legs_lever, trainingProgram.day_3_balanced_planche_core];
      let html = renderNav() + renderProgress();
      html += renderDay(days[activeDayIdx], activeDayIdx);
      html += renderTips();
      html += renderRecovery();
      document.getElementById('app').innerHTML = html;
    }

    // --- INIT DATA ---
    // trainingProgram = ... сконвертируйте JSON payload из application_data_json в JS объект
    trainingProgram.day_1_push_handstand = { /* ... все структуры первого дня ... */ };
    trainingProgram.day_2_pull_legs_lever = { /* ... все структуры второго дня ... */ };
    trainingProgram.day_3_balanced_planche_core = { /* ... все структуры третьего дня ... */ };
    trainingProgram.tips_and_recommendations = { /* ... */ };
    trainingProgram.recovery_nutrition = { /* ... */ };
    // (ПОДСТАВЬТЕ СЮДА ДАННЫЕ ЦЕЛИКОМ ИЗ application_data_json!)

    // --- first render ---
    update();
  </script>
</body>
</html>
